# =============================================================================
# Dockerfile: сборочный образ для приложения "ferum_customs" поверх ERPNext v15
# =============================================================================
ARG ERP_TAG=v15.65.4                # можно переопределять через build-arg
FROM frappe/erpnext-worker:${ERP_TAG}

# ──────────────────────────────────────────────────────────────────────────────
# 1. Доп. пакеты (опционально)
# ──────────────────────────────────────────────────────────────────────────────
USER root
RUN apt-get update \
 && apt-get install -y --no-install-recommends vim git \
 && rm -rf /var/lib/apt/lists/*

# ──────────────────────────────────────────────────────────────────────────────
# 2. Работаем от пользователя frappe
# ──────────────────────────────────────────────────────────────────────────────
USER frappe
WORKDIR /home/frappe/frappe-bench

# ──────────────────────────────────────────────────────────────────────────────
# 3. Python-зависимости приложения
# ──────────────────────────────────────────────────────────────────────────────
COPY --chown=frappe:frappe requirements.txt /tmp/requirements.txt
RUN if [ -s /tmp/requirements.txt ]; then ./env/bin/pip install --no-cache-dir -r /tmp/requirements.txt; fi

# ──────────────────────────────────────────────────────────────────────────────
# 4. Код приложения
# ──────────────────────────────────────────────────────────────────────────────
COPY --chown=frappe:frappe . ./apps/ferum_customs

# ──────────────────────────────────────────────────────────────────────────────
# 5. Установка приложения на дефолтный сайт (site1.local)
# ──────────────────────────────────────────────────────────────────────────────
RUN bench --site site1.local install-app ferum_customs \
 && bench build --app ferum_customs

# ENTRYPOINT остаётся тем, что задан в базовом образе ("bench")
