# =============================================================================
# Dockerfile: Сборочный образ для приложения "ferum_customs"
# Основан на стабильной версии ERPNext v15
# =============================================================================

# Используем ARG, чтобы можно было переопределять версию базового образа при сборке.
# v15.30.0 - это стабильный, существующий тег. Замените его на нужный вам, например, ${{ env.ERPNEXT_TAG }} в CI.
ARG ERP_TAG=v15.30.0
FROM frappe/erpnext-worker:${ERP_TAG}

# ──────────────────────────────────────────────────────────────────────────────
# 1. Дополнительные пакеты (опционально)
# ──────────────────────────────────────────────────────────────────────────────
USER root
RUN apt-get update && \
    apt-get install -y --no-install-recommends vim git && \
    rm -rf /var/lib/apt/lists/*

# ──────────────────────────────────────────────────────────────────────────────
# 2. Работа от имени пользователя frappe
# ──────────────────────────────────────────────────────────────────────────────
USER frappe
WORKDIR /home/frappe/frappe-bench

# ──────────────────────────────────────────────────────────────────────────────
# 3. Установка Python-зависимостей вашего приложения
# Копируем сначала только этот файл, чтобы лучше использовать кэширование Docker.
# ──────────────────────────────────────────────────────────────────────────────
COPY --chown=frappe:frappe requirements.txt /tmp/requirements.txt
RUN if [ -s /tmp/requirements.txt ]; then ./env/bin/pip install --no-cache-dir -r /tmp/requirements.txt; fi

# ──────────────────────────────────────────────────────────────────────────────
# 4. Копирование кода вашего приложения
# ──────────────────────────────────────────────────────────────────────────────
COPY --chown=frappe:frappe . ./apps/ferum_customs

# ──────────────────────────────────────────────────────────────────────────────
# 5. Установка приложения и сборка ассетов
# Установка будет производиться на сайт, который создается в CI-пайплайне.
# Здесь мы только собираем ассеты, чтобы они были готовы.
# ──────────────────────────────────────────────────────────────────────────────
RUN bench build --app ferum_customs

# ENTRYPOINT остается таким, как в базовом образе.
