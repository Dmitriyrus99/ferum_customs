Руководство по архитектуре и разработке "Ferum Customizations"
1. Цель и Обзор Проекта
Проект "Ferum Customizations" представляет собой кастомное приложение для платформы Frappe/ERPNext, разработанное для комплексного управления проектами и сервисными заявками.

Основные цели:

Автоматизация: Устранение ручной обработки документов и автоматизация учета и документооборота.

Прозрачность: Повышение прозрачности всех рабочих процессов, от создания заявки до ее закрытия.

Контроль: Обеспечение контроля над сроками и качеством выполнения работ.

Упрощение взаимодействия: Интеграция с Telegram-ботом для быстрого создания заявок и получения уведомлений.

"Проект Ferum Customizations обладает всеми задатками, чтобы стать эффективной системой управления проектами и сервисными заявками."

2. Архитектура и Технологический Стек
Система построена как приложение (модуль) для Frappe Framework, что определяет монолитную веб-архитектуру с клиент-серверным подходом.

2.1. Серверная часть (Backend)
Платформа: Frappe Framework (v15)

Язык программирования: Python (>=3.10)

СУБД: MariaDB (основная для Frappe), PostgreSQL (для потенциальных внешних сервисов)

ORM: Встроенная ORM Frappe для работы с DocType.

Фоновые задачи и Кэш: Redis

API: Frappe REST API (основной), FastAPI (для высокопроизводительных кастомных эндпоинтов), Aiogram (для Telegram-бота).

2.2. Клиентская часть (Frontend)
Основной интерфейс: Стандартный UI Frappe (Desk, веб-формы)

Технологии: JavaScript (ES6+), jQuery, HTML5, CSS3. Используется для написания клиентских скриптов к DocType.

Сборка: Node.js используется для сборки фронтенд-ассетов.

2.3. Инструменты и CI/CD
Контейнеризация: Docker, Docker Compose.

Непрерывная интеграция: GitHub Actions (для запуска линтеров и тестов).

Качество кода: Pre-commit хуки, Ruff (Python), ESLint/Prettier (JavaScript).

3. Ключевые компоненты и структура проекта
Проект имеет стандартную структуру Frappe-приложения.

3.1. Основные директории
ferum_customs/doctype/: Определения ключевых сущностей системы (DocType). Каждый DocType представлен директорией, содержащей:

[doctype_name].json: Определение полей, связей и метаданных.

[doctype_name].py: Серверная логика (хуки, валидации).

[doctype_name].js: Клиентская логика (скрипты для форм).

ferum_customs/custom_logic/: Основная бизнес-логика, вынесенная из .py файлов DocType для лучшей структурированности.

ferum_customs/permissions/: Логика для динамических прав доступа (Permission Query Conditions).

ferum_customs/fixtures/: Данные для первоначальной настройки системы (роли, права, пункты меню, workflow).

telegram_bot/: Логика для интеграции с Telegram-ботом.

hooks.py: Главный конфигурационный файл приложения, связывающий код с событиями Frappe (создание документа, изменение статуса и т.д.).

3.2. Ключевые DocTypes (Сущности)
Service Project: Проект. Основная сущность, к которой привязываются объекты обслуживания и заявки.

Service Object: Объект обслуживания. Конкретный актив или место, связанное с проектом (например, здание, оборудование).

Service Request: Сервисная заявка. Основной документ для отслеживания задач. Имеет свой жизненный цикл, управляемый статусами и, опционально, Workflow.

Service Report: Сервисный отчет. Документ, который создает инженер по итогам выполнения работ. Является обязательным для закрытия Service Request.

Custom Attachment: Кастомное вложение. Расширяет стандартный функционал для привязки специфичных файлов (например, фотоотчетов).

3.3. Интеграция с Telegram-ботом (aiogram)
Бот построен на модульной архитектуре с использованием Router из aiogram:

Разделение логики: Для каждой роли пользователя (инженер, клиент и т.д.) существует свой роутер с набором хендлеров.

Машина состояний (FSM): Используется для пошагового ввода данных, например, при создании новой заявки или загрузке документов.

Аутентификация: Происходит по номеру телефона, который сверяется с базой пользователей в ERPNext.

4. Роли Пользователей и Права Доступа
Система имеет проработанную ролевую модель для обеспечения безопасности и разграничения доступа.

Роль

Основные права и обязанности

Администратор

Полный доступ ко всем модулям и настройкам системы.

Руководитель проекта

Создание и управление проектами (Service Project), заявками (Service Request). Доступ к финансовым документам.

Офис-менеджер

Создание заявок от имени клиентов, загрузка счетов. Ограниченный доступ: не может редактировать ключевые данные.

Инженер

Просмотр назначенных заявок, изменение их статусов, создание сервисных отчетов (Service Report). Получает уведомления.

Клиент / Заказчик

Создание и отслеживание статуса только своих заявок через портал или бота. Доступ к данным других клиентов строго запрещен.

Главный бухгалтер

Доступ к финансовым документам (счета, акты).

Безопасность данных клиентов
Ключевой аспект безопасности — изоляция данных клиентов. Это достигается с помощью механизма Frappe permission_query_conditions:

Для каждого пользователя с ролью "Заказчик" создается запись User Permission, которая связывает его с конкретным клиентом (Customer).

В файле ferum_customs/permissions/permissions.py определена функция, которая для роли "Заказчик" динамически добавляет SQL-условие WHERE customer = '...' ко всем запросам, гарантируя, что пользователь видит только документы, относящиеся к его компании.

5. Основной Функционал и Бизнес-логика
5.1. Жизненный цикл сервисной заявки (Service Request)
Создание: Заявка может быть создана Офис-менеджером, Руководителем или самим Клиентом.

Назначение: Руководитель назначает ответственного инженера.

В работе: Инженер берет заявку в работу.

Выполнение: После выполнения работ инженер создает Service Report.

Закрытие: Заявку можно закрыть только при наличии связанного Service Report. Эта валидация реализована через серверный хук.

5.2. Управление документами
Нумерация: Документы имеют автоматическую нумерацию (например, REQ-... для заявок).

Связи: Frappe автоматически отслеживает связи между документами. Например, нельзя удалить Service Request, если к нему привязан счет (Sales Invoice).

5.3. Соглашения по коду
Хуки: Вся серверная бизнес-логика (валидации, автоматизации) должна быть реализована через хуки в hooks.py и соответствующие функции в .py файлах DocType или в директории custom_logic.

Константы: Статусы, роли и другие фиксированные значения должны быть вынесены в ferum_customs/constants.py.

Клиентские скрипты: Логика, работающая в браузере (скрытие/показ полей, кастомные кнопки), пишется в .js файлах DocType.

Качество: Все разработчики обязаны использовать pre-commit для автоматической проверки и форматирования кода перед коммитом.

6. Локальная разработка и тестирование
6.1. Настройка окружения
Склонируйте репозиторий.

Убедитесь, что у вас установлен Docker и Docker Compose.

Запустите окружение командой:

docker compose -f docker-compose.yml -f docker-compose.test.yml up -d

Установите зависимости и приложение ferum_customs:

docker compose exec frappe bash
bench get-app ferum_customs https://github.com/dmitriyrus99/ferum_customs
bench --site frontend install-app ferum_customs

6.2. Запуск тестов
Для запуска тестов используйте команду bench:

# Запустить все тесты для приложения ferum_customs
bench --site frontend run-tests --app ferum_customs

# Запустить тесты для конкретного модуля
bench --site frontend run-tests --module "Service Request"
