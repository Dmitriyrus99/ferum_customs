name: tests

on: [push, pull_request]

jobs:
  server:
    runs-on: ubuntu-22.04
    env:
      SITE_NAME: test_site
      ADMIN_PASSWORD: admin
    steps:
      - uses: actions/checkout@v4

      - name: Start stack
        run: |
          docker compose -f docker-compose.test.yml up -d

      - name: Install app + ERPNext + deps
        run: |
          docker compose exec -T frappe bash -c "
            bench get-app --branch develop erpnext https://github.com/frappe/erpnext &&
            bench get-app ferum_customs /workspace &&
            bench setup requirements --dev &&
            bench new-site --db-root-password root --admin-password $ADMIN_PASSWORD $SITE_NAME &&
            bench --site $SITE_NAME install-app erpnext &&
            bench --site $SITE_NAME install-app ferum_customs &&
            bench pip install pytest pytest-cov
          "

      - name: Run tests
        run: |
          docker compose exec -T frappe bash -c "
            bench --site $SITE_NAME set-config allow_tests true &&
            bench --site $SITE_NAME run-tests --app ferum_customs
          "
