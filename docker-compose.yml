services:
  mariadb:
    image: mariadb:10.6
    container_name: mariadb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mariadb-data:/var/lib/mysql

  redis:
    image: redis:6.2-alpine
    container_name: redis
    restart: unless-stopped
    volumes:
      - redis-data:/data

  frappe:
    image: frappe/erpnext:${ERPNEXT_TAG}           # —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –≥–æ—Ç–æ–≤—ã–π –æ–±—Ä–∞–∑
    container_name: frappe
    restart: unless-stopped
    depends_on:
      - mariadb
      - redis

    environment:
      SITE_NAME: ${SITE_NAME}             # ‚Üê –ø–æ–º–µ–Ω—è–π—Ç–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}               # ‚Üê –∑–∞–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–∞—Ä–æ–ª—å

    # –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –û–î–ù–ò–ú bash-—Å–∫—Ä–∏–ø—Ç–æ–º
    command: |
      bash -eux -c '
        cd /home/frappe/frappe-bench

        echo "‚è≥ –ñ–¥—ë–º 30 —Å, –ø–æ–∫–∞ MariaDB –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è‚Ä¶"
        sleep 30
        pip install --no-cache-dir -U "frappe-bench==${BENCH_TAG}"

        echo "üì¶ –ö–ª–æ–Ω–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ferum_customs‚Ä¶"
        bench get-app --branch main --overwrite https://github.com/Dmitriyrus99/ferum_customs.git

        echo "‚öôÔ∏è  –°–æ–∑–¥–∞—ë–º —Å–∞–π—Ç –∏ —Å—Ç–∞–≤–∏–º ERPNext + –∫–∞—Å—Ç–æ–º-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ‚Ä¶"
        bench new-site "$SITE_NAME" \
          --admin-password "$ADMIN_PASSWORD" \
          --db-root-password ${DB_ROOT_PASSWORD} \
          --no-mariadb-socket \
          --db-host mariadb --db-port 3306 \
          --install-app erpnext && \
        bench --site "$SITE_NAME" install-app ferum_customs

        echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Frappe (bench start)‚Ä¶"
        bench setup procfile
      '

    # –¥–∞–Ω–Ω—ã–µ —Å–∫–ª–∞–¥—ã–≤–∞–µ–º –≤ —Ç–æ–º–∞, —á—Ç–æ–±—ã –Ω–µ –≤–æ–∑–∏—Ç—å—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ —Ö–æ—Å—Ç–µ
    volumes:
      - frappe-sites:/home/frappe/frappe-bench/sites
      - frappe-apps:/home/frappe/frappe-bench/apps

    ports:
      - "8001:8000"   # –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      - "9001:9000"   # socket.io (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

volumes:
  mariadb-data:
  redis-data:
  frappe-sites:
  frappe-apps:

